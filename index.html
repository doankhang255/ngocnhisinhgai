<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Thi·ªáp t√¨nh y√™u üíå</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&family=Nunito:wght@400;600&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
<style>
:root{
  --brand:#e94e77;
  --ink:#1f2937;
  --muted:#6b7280;
  --paper:#FFF8F9;
  --cover:#FFF0F5;
  --bg:#FFFFFF1A;
  --card-w: 500px;
  --card-ratio: 5/6;
}

*{box-sizing:border-box}
body{
  margin:0; overflow:hidden;
  min-height:100vh;
  background:var(--bg);
  font-family:"Nunito","Segoe UI",system-ui,sans-serif;
  display:flex; justify-content:center; align-items:center;
}

/* tr√°i tim ƒë·ªông */
#pinkboard{
  position:absolute;
  top:50%; 
  left:50%;
  width: 400px;      /* üëà chi·ªÅu r·ªông tr√°i tim */
  height: 400px;     /* üëà chi·ªÅu cao tr√°i tim (gi·ªØ vu√¥ng cho c√¢n) */
  transform:translate(-50%,-50%);
  animation:beat 1.5s ease infinite;
  cursor:pointer;
  z-index:2;
}
@keyframes beat{
  0%,100%{transform:translate(-50%,-50%) scale(1);}
  30%{transform:translate(-50%,-50%) scale(.9);}
}

/* ch·ªØ ‚ÄúM·ªû ƒêI‚Äù tr√™n tim */
#openText{
  position:absolute; top:48%; left:50%; transform:translate(-50%,-50%);
  font-family:"Dancing Script", cursive; font-size:20px; font-weight:800;
  color:#ffb6c1; text-shadow:0 0 14px rgba(255,105,180,.6);
  cursor:pointer; z-index:3; letter-spacing:1px;
}

/* Thi·ªáp (·∫©n l√∫c ƒë·∫ßu) */
.hidden{display:none;}
.stage{perspective:1600px;}

/* Card responsive: h∆°i cao (5/6), kh√¥ng tr√†n m√†n h√¨nh */
.card{
  position: relative;
  width: 500px;      /* üëà chi·ªÅu r·ªông thi·ªáp */
  height: 820px;     /* üëà chi·ªÅu cao thi·ªáp ‚Äì ch·ªânh cao h∆°n n·∫øu mu·ªën d√†i h∆°n */
  max-width: 96vw;   /* v·∫´n co l·∫°i tr√™n ƒëi·ªán tho·∫°i */
  max-height: 92vh;  /* kh√¥ng tr√†n m√†n h√¨nh */
  background: var(--paper);
  border-radius: 18px;
  box-shadow: 0 28px 70px rgba(0,0,0,.18);
  border: 1px solid rgba(0,0,0,.06);
  overflow: hidden;
}

/* Trang trong */
.inner{ position:absolute; inset:0; display:grid; grid-template-columns:1fr 1fr; z-index:1; }
.page{ padding:28px 26px; }
.left{
  background:radial-gradient(900px 260px at -10% 0%, rgba(233,78,119,.08), transparent 60%), var(--paper);
}
.right{
  background:radial-gradient(900px 260px at 110% 0%, rgba(233,78,119,.08), transparent 60%), var(--paper);
}

/* Cho ph√©p ph·∫ßn l·ªùi nh·∫Øn cu·ªôn n·∫øu qu√° d√†i */
.page.right{
  position: relative;
  overflow-y: auto;      /* üëà b·∫≠t cu·ªôn d·ªçc */
  max-height: 100%;      /* gi·ªØ trong chi·ªÅu cao thi·ªáp */
  padding-right: 10px;   /* ch·ª´a kho·∫£ng cho thanh cu·ªôn */
  scrollbar-width: thin; /* thanh cu·ªôn m·∫£nh cho tr√¨nh duy·ªát h·ªó tr·ª£ */
}
/* T√πy ch·ªânh thanh cu·ªôn (cho Chrome, Edge, Safari) */
.page.right::-webkit-scrollbar {
  width: 6px;                 /* m·∫£nh v·ª´a ph·∫£i */
}
.page.right::-webkit-scrollbar-thumb {
  background: #e9a7b3;        /* h·ªìng pastel d·ªãu */
  border-radius: 6px;
}
.page.right::-webkit-scrollbar-track {
  background: transparent;
}

.ribbon{display:inline-block;padding:6px 12px;border-radius:999px;background:rgba(233,78,119,.12);color:var(--brand);font-weight:800;letter-spacing:.3px;font-size:12px;}
h1{font-size:36px;line-height:1.15;margin:12px 0 8px}
.lead{color:var(--muted);font-size:18px;margin:0 0 12px}
.section-title{text-transform:uppercase;font-size:12px;letter-spacing:.5px;color:var(--muted);margin:14px 0 6px}
.big{font-size:22px;font-weight:800;line-height:1.35;}
.note{color:var(--muted);margin-top:6px}
.title-love{
  font-family: "Pacifico", cursive;
  color:#e94e77;
  font-size:28px;
  font-weight:700;
  text-shadow: 0 0 6px rgba(233,78,119,0.2);
}
.yeu{
  font-family: "Pacifico", cursive;
  color:#1f1f1f;
  font-size:28px;
  font-weight:700;
}
/* B√¨a g·∫≠p */
.cover{
  position:absolute; top:0; bottom:0; right:0; width:50%;
  transform-origin:left center; transform-style:preserve-3d;
  transition:transform .9s cubic-bezier(.2,.7,.2,1);
  background:var(--cover);
  border-left:1px solid rgba(0,0,0,.06);
  will-change:transform;
  z-index:5;
}
.cover-outer,.cover-inner{
  position:absolute; inset:0; backface-visibility:hidden;
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  text-align:center; padding:32px;
}
.cover-outer{
  background:radial-gradient(1200px 300px at 50% -10%, rgba(233,78,119,.12), transparent 60%), var(--cover);
}
.cover-inner{ transform:rotateY(180deg); background:#fff7fa; }
.card.open .cover{ transform:rotateY(-180deg); }

.hint{text-align:center;margin-top:12px;color:var(--muted);font-size:14px}

/* ============ PIN overlay n·ª≠a tr√°i + ·∫©n khi m·ªü/in ============ */
.pin-overlay-left{
  position:absolute;
  top: 40%;         /* üëà c√¥ thay ƒë·ªïi gi√° tr·ªã n√†y ƒë·ªÉ d·ªãch l√™n/xu·ªëng */
  left: 0;
  width: 50%;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:16px;
  z-index:8;                 /* n·ªïi tr√™n ph·∫ßn trong thi·ªáp */
  pointer-events:auto;
  backdrop-filter: blur(2px);
}
.card.open .pin-overlay-left{
  opacity:0; pointer-events:none; transition:opacity .35s ease;
}
@media print{
  .pin-overlay-left{ display:none !important; }
}

/* B√™n trong khung PIN: g·ªçn & v·ª´a khung thi·ªáp */
.pin-box{
  background:#fff;
  border:1px solid rgba(0,0,0,.08);
  border-radius:16px;
  width: 280px;     /* üëà chi·ªÅu r·ªông t·ªïng th·ªÉ khung */
  height: 300px;    /* üëà chi·ªÅu cao t·ªïng th·ªÉ khung */
  padding:14px 12px;
  margin: 40px auto 0px;   /* cƒÉn gi·ªØa */
  text-align:center;
  user-select:none;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  transition: box-shadow .25s ease, border-color .25s ease;
}
.pin-box.success{ box-shadow:0 0 0 4px rgba(16,185,129,.2); border-color:#10b981; }
.pin-box.error{ animation: pin-shake .4s; border-color:#ef4444; }
@keyframes pin-shake{
  10%,90%{transform:translateX(-1px);}
  20%,80%{transform:translateX(2px);}
  30%,50%,70%{transform:translateX(-4px);}
  40%,60%{transform:translateX(4px);}
}
.pin-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
.pin-title{ font-weight:700; color:#e94e77; letter-spacing:.3px; font-size:15px; }
.pin-eye{ border:none; background:transparent; cursor:pointer; font-size:18px; line-height:1; opacity:.7; transition:opacity .2s ease, transform .1s ease; }
.pin-eye:hover{ opacity:1; } .pin-eye:active{ transform:scale(.96); }

.pin-visual{ display:flex; justify-content:center; gap:8px; margin:8px 0 10px; }
.pin-digit{
  width:34px; height:44px; border-radius:10px;
  border:2px solid rgba(0,0,0,.15);
  display:flex; align-items:center; justify-content:center;
  font-weight:800; font-size:18px; color:#1f2937;
  transition:border-color .2s ease, transform .08s ease;
}
.pin-digit.filled{ border-color:#e94e77; }
.pin-digit.flash{ transform:scale(1.08); }
.pin-digit .dot{ width:8px; height:8px; border-radius:50%; background:#1f2937; }

.pin-progress{ height:5px; background:#f3f4f6; border-radius:999px; overflow:hidden; margin:0 20% 10px; }
.pin-progress-bar{ height:100%; width:0%; background:#e94e77; transition: width .2s ease; }

.keypad{ display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; max-width:260px; margin:0 auto; }
.key{
  padding:10px 0; font-size:17px; font-weight:700; background:#fff;
  border:1px solid rgba(0,0,0,.1); border-radius:10px; cursor:pointer;
  transition:transform .05s ease, background .15s ease, box-shadow .15s ease;
  box-shadow:0 2px 0 rgba(0,0,0,.05);
}
.key:hover{ background:#fff7fa; } .key:active{ transform:translateY(1px); }
.key.accent{ background:var(--brand); color:#fff; border-color:transparent; }
.key.icon{ font-weight:600; }

.msg{ margin-top:8px; color:var(--muted); font-size:13px; min-height:18px; }
.small-hint{ margin-top:8px; color:#9ca3af; font-size:12px; }
.pin-hidden-input{ position:absolute; opacity:0; pointer-events:none; width:0; height:0; }

/* Mobile tweaks */
@media (max-width:640px){
  /* Cho ph√©p cu·ªôn d·ªçc + ch·ª´a v√πng notch */
  html, body { height:auto; overflow-y:auto; }
  body{ padding-top:max(10px, env(safe-area-inset-top)); padding-bottom:16px; }

  /* Thu nh·ªè tr√°i tim */
  #pinkboard{ width:min(70vw, 360px); height:min(70vw, 360px); }

  /* Card vu√¥ng tr√™n mobile theo √Ω c√¥ tr∆∞·ªõc */
  .card{ width:94vw; max-height:86vh; aspect-ratio:1/1; height:auto; margin:10px auto 20px; }

  /* Overlay: full ngang cho d·ªÖ b·∫•m */
  .pin-overlay-left{ width:100%; left:0; justify-content:center; padding:12px; }

  .pin-box{ padding:14px 10px; max-width:300px; }
  .pin-digit{ width:30px; height:40px; font-size:16px; }
  .keypad{ max-width:220px; gap:6px; }
  .key{ padding:8px 0; font-size:16px; }
}
</style>
</head>
<body>

<!-- Tr√°i tim ƒë·ªông -->
<canvas id="pinkboard"></canvas>
<div id="openText">ch·∫°m v√¥ ƒë√¢y ·ª£ üíå</div>

<!-- Thi·ªáp (·∫©n) -->
<div class="stage hidden" id="inviteStage">
  <div class="card" id="card">
    <div class="inner">
      <div class="page left">
        <span class="ribbon">THI·ªÜP T·ªàNH C·ª¶M</span>
        <h2 class="big title-love">G·ª≠i ƒë·∫øn Nh√≠ IU c·ª•a anh ·ª£</h2>
        <p class="lead">C·∫£m ∆°n em ƒë√£ l√† m·ªôt ph·∫ßn cu·ªôc s·ªëng c·ªßa anh ‚Çä¬∑ ÕüÕüÕûÕû‚û≥‚ù• ‚ô•‚Äø‚ô•</p>
      </div>

      <div class="page right">
        <div class="section-title">L·ªùi nh·∫Øn</div>
        <div> <h4>Ch√∫c m·ª´ng ng√†y ph·ª• n·ªØ Vi·ªát Nam 20/10! v√† c≈©ng 2 th√°ng m√¨nh b√™n nhau r·ªìi. Ng√†y h√¥m nay anh mu·ªën d√†nh t·∫•t c·∫£ nh·ªØng l·ªùi ch√∫c t·ªët ƒë·∫πp nh·∫•t ƒë·∫øn em, ng∆∞·ªùi con g√°i m√† anh y√™u th∆∞∆°ng. 
          C·∫£m ∆°n em ƒë√£ b√™n anh trong th·ªùi gian qua (c·ª• th·ªÉ 2 th√°ng h·∫π h·∫π). C·∫£m ∆°n em lu√¥n hi·ªÉu cho anh, em lu√¥n l√† ngu·ªìn c·∫£m h·ª©ng v√† l√Ω do anh lu√¥n c·ªë g·∫Øng ƒë·ªÉ tr·ªü th√†nh ng∆∞·ªùi t·ªët h∆°n.
          <br>Ch√∫c em ng√†y m·ªõi th·∫≠t vui v·∫ª v√† tr√†n ƒë·∫ßy y√™u th∆∞∆°ng.</h4>
        </div>
        <p class="note">T·ª´ anh, ng∆∞·ªùi lu√¥n y√™u th∆∞∆°ng em ‚ô•</p>
      </div>
    </div>

    <!-- PIN overlay n·ª≠a tr√°i -->
    <div class="pin-overlay-left" id="pinOverlay">
      <div class="pin-box pin-theme" aria-label="Nh·∫≠p m√£ PIN">
        <div class="pin-header">
          <div class="pin-title">NH√ç IU</div>
          <button class="pin-eye" id="toggleMask" aria-label="Hi·ªán/·∫©n s·ªë" title="Hi·ªán/·∫©n s·ªë"></button>
        </div>

        <div class="pin-visual" id="pinDots" aria-live="polite"></div>

        <div class="pin-progress">
          <div class="pin-progress-bar" id="pinProg"></div>
        </div>

        <div class="keypad" id="keypad" role="group" aria-label="B√†n ph√≠m s·ªë">
          <button class="key" data-key="1">1</button>
          <button class="key" data-key="2">2</button>
          <button class="key" data-key="3">3</button>
          <button class="key" data-key="4">4</button>
          <button class="key" data-key="5">5</button>
          <button class="key" data-key="6">6</button>
          <button class="key" data-key="7">7</button>
          <button class="key" data-key="8">8</button>
          <button class="key" data-key="9">9</button>
          <button class="key icon" data-action="clear" title="Xo√°">‚å´</button>
          <button class="key" data-key="0">0</button>
          <button class="key icon accent" data-action="ok" title="X√°c nh·∫≠n">OK</button>
        </div>

        <div class="msg" id="msg" aria-live="polite">G·ª£i √Ω: m√£ 4 s·ªë ‚ô•</div>
        <input id="hiddenPinInput" inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code" class="pin-hidden-input" />
      </div>
    </div>

    <!-- B√¨a -->
    <div class="cover" id="cover">
      <div class="cover-outer">
        <p class="lead">nh·∫≠p m·∫≠t kh·∫©u xongg b·∫•m t√≠p v√¥ ƒë√¢y n√® ÔÆ©Ÿ®ŸÄÔÆ©ÔÆ©Ÿ®ŸÄ‚ô°ÔÆ©Ÿ®ŸÄÔÆ©ÔÆ©Ÿ®ŸÄ</p>
      </div>
      <div class="cover-inner">
        <p class="lead">‚ô• hello h√≠ h√≠ ƒë·ªçc n·ªôi dung b√™n tr√°i √≥oo ‚ô•</p>
      </div>
    </div>
  </div>
</div>

<script>
/* ------------------ LOGIC M·ªû THI·ªÜP ------------------- */
const openText = document.getElementById('openText');
const canvasHeart = document.getElementById('pinkboard');
const stage = document.getElementById('inviteStage');
const card = document.getElementById('card');
openText.addEventListener('click', ()=>{
  canvasHeart.style.display='none';
  openText.style.display='none';
  stage.classList.remove('hidden');
});

/* ------------------ PIN KEYPAD (custom) ------------------- */
const PIN = "0812";               // ƒë·ªïi m√£ t·∫°i ƒë√¢y
const maskDuration = 700;         // ms: hi·ªán s·ªë th·∫≠t 0.7s r·ªìi che l·∫°i (khi ƒëang ·∫©n)

const msg = document.getElementById('msg');
const pinDots = document.getElementById('pinDots');
const pinProg = document.getElementById('pinProg');
const keypad = document.getElementById('keypad');
const pinBox = document.querySelector('.pin-box');
const toggleMaskBtn = document.getElementById('toggleMask');
const hiddenInput = document.getElementById('hiddenPinInput');

let buffer = "";
let showPlain = false;
let lastFlashTimer = null;

function buildDigits(){
  pinDots.innerHTML = "";
  for(let i=0;i<PIN.length;i++){
    const d = document.createElement('div');
    d.className = 'pin-digit';
    d.dataset.index = i;
    pinDots.appendChild(d);
  }
  updateVisual();
}
buildDigits();

function updateVisual(){
  const pct = Math.min(100, Math.round(buffer.length / PIN.length * 100));
  pinProg.style.width = pct + "%";

  const digits = [...pinDots.children];
  digits.forEach((el, i)=>{
    el.classList.toggle('filled', i < buffer.length);
    el.innerHTML = '';
    if(i < buffer.length){
      if(showPlain){ el.textContent = buffer[i]; }
      else{
        const dot = document.createElement('div');
        dot.className = 'dot';
        el.appendChild(dot);
      }
    }
  });
}

function flashLast(){
  if(!pinDots.children.length) return;
  const idx = buffer.length - 1;
  if(idx < 0) return;
  const el = pinDots.children[idx];
  el.classList.add('flash');
  clearTimeout(lastFlashTimer);
  lastFlashTimer = setTimeout(()=>el.classList.remove('flash'), 120);
}

function shakeError(){
  pinBox.classList.remove('success');
  pinBox.classList.add('error');
  setTimeout(()=>pinBox.classList.remove('error'), 450);
}
function successPulse(){
  pinBox.classList.add('success');
  setTimeout(()=>pinBox.classList.remove('success'), 1200);
}

function tryUnlock(){
  if(buffer.length !== PIN.length){
    msg.textContent = `Nh·∫≠p ƒë·ªß ${PIN.length} s·ªë nh√©!`;
    msg.style.color = "#b45309";
    shakeError();
    return;
  }
  if(buffer === PIN){
    msg.textContent = "‚úî M·∫≠t kh·∫©u ƒë√∫ng! Thi·ªáp ƒëang m·ªü...";
    msg.style.color = "green";
    successPulse();
    card.classList.add('open');
  }else{
    msg.textContent = "‚ùå Sai m√£ r·ªìi, th·ª≠ l·∫°i nh√©!";
    msg.style.color = "red";
    buffer = "";
    updateVisual();
    shakeError();
  }
}

function pushDigit(d){
  if(!/^\d$/.test(d)) return;
  if(buffer.length >= PIN.length) return;
  buffer += d;
  updateVisual();
  flashLast();

  if(!showPlain){
    const idx = buffer.length - 1;
    const el = pinDots.children[idx];
    el.textContent = d;
    setTimeout(()=>{
      if(buffer.length > idx && !showPlain){
        el.innerHTML = '<div class="dot"></div>';
      }
    }, maskDuration);
  }
}
function popDigit(){ buffer = buffer.slice(0,-1); updateVisual(); }
function clearAll(){
  buffer = "";
  updateVisual();
  msg.textContent = "ƒê√£ xo√°, nh·∫≠p l·∫°i nh√©.";
  msg.style.color = "#6b7280";
}

let clearHoldTimer = null;
keypad.addEventListener('mousedown', (e)=>{
  const btn = e.target.closest('.key[data-action="clear"]');
  if(!btn) return;
  clearHoldTimer = setTimeout(()=>{ clearAll(); }, 500);
});
window.addEventListener('mouseup', ()=>{ clearTimeout(clearHoldTimer); });
keypad.addEventListener('mouseleave', ()=>{ clearTimeout(clearHoldTimer); });

keypad.addEventListener('click', (e)=>{
  const t = e.target.closest('.key');
  if(!t) return;
  const key = t.getAttribute('data-key');
  const action = t.getAttribute('data-action');

  if(key){ pushDigit(key); }
  else if(action === 'clear'){ popDigit(); }
  else if(action === 'ok'){ tryUnlock(); }
});

window.addEventListener('keydown', (e)=>{
  if(/^\d$/.test(e.key)) pushDigit(e.key);
  else if(e.key === 'Backspace') popDigit();
  else if(e.key === 'Enter') tryUnlock();
});

hiddenInput.addEventListener('input', ()=>{
  const val = (hiddenInput.value || "").replace(/\D/g,'');
  if(!val) return;
  for(const ch of val){ pushDigit(ch); }
  hiddenInput.value = "";
});
pinBox.addEventListener('click', ()=> hiddenInput.focus());

toggleMaskBtn.addEventListener('click', ()=>{
  showPlain = !showPlain;
  updateVisual();
});

/* ------------------ HI·ªÜU ·ª®NG TR√ÅI TIM ------------------- */
var settings = { particles:{length:700,duration:1.5,velocity:100,effect:-0.85,size:24} };
(function(){
  var Point=function(x,y){this.x=x||0;this.y=y||0};
  Point.prototype.clone=function(){return new Point(this.x,this.y)};
  Point.prototype.length=function(len){
    if(len===undefined)return Math.sqrt(this.x*this.x+this.y*this.y);
    this.normalize();this.x*=len;this.y*=len;return this;
  };
  Point.prototype.normalize=function(){var l=this.length();this.x/=l;this.y/=l;return this;};
  var Particle=function(){this.position=new Point();this.velocity=new Point();this.acceleration=new Point();this.age=0;};
  Particle.prototype.initialize=function(x,y,dx,dy){
    this.position.x=x;this.position.y=y; this.velocity.x=dx;this.velocity.y=dy;
    this.acceleration.x=dx*settings.particles.effect; this.acceleration.y=dy*settings.particles.effect; this.age=0;
  };
  Particle.prototype.update=function(d){
    this.position.x+=this.velocity.x*d; this.position.y+=this.velocity.y*d;
    this.velocity.x+=this.acceleration.x*d; this.velocity.y+=this.acceleration.y*d; this.age+=d;
  };
  Particle.prototype.draw=function(ctx,img){
    var ease=t=>--t*t*t+1;
    var size=img.width*ease(this.age/settings.particles.duration);
    ctx.globalAlpha=1-this.age/settings.particles.duration;
    ctx.drawImage(img,this.position.x-size/2,this.position.y-size/2,size,size);
  };
  var ParticlePool=function(l){
    var particles=new Array(l); for(let i=0;i<l;i++)particles[i]=new Particle();
    var firstActive=0,firstFree=0,duration=settings.particles.duration;
    this.add=function(x,y,dx,dy){ particles[firstFree].initialize(x,y,dx,dy); firstFree=(firstFree+1)%l; if(firstActive===firstFree)firstActive=(firstActive+1)%l; };
    this.update=function(dt){
      var i;
      if(firstActive<firstFree){ for(i=firstActive;i<firstFree;i++)particles[i].update(dt); }
      else{ for(i=firstActive;i<l;i++)particles[i].update(dt); for(i=0;i<firstFree;i++)particles[i].update(dt); }
      while(particles[firstActive].age>=duration && firstActive!==firstFree){ firstActive=(firstActive+1)%l; }
    };
    this.draw=function(ctx,img){
      var i;
      if(firstActive<firstFree){ for(i=firstActive;i<firstFree;i++)particles[i].draw(ctx,img); }
      else{ for(i=firstActive;i<l;i++)particles[i].draw(ctx,img); for(i=0;i<firstFree;i++)particles[i].draw(ctx,img); }
    };
  };

  (function(canvas){
    var ctx=canvas.getContext('2d');
    var particles=new ParticlePool(settings.particles.length);
    var particleRate=settings.particles.length/settings.particles.duration;
    var time;

    function pointOnHeart(t){
      return new Point(
        160*Math.pow(Math.sin(t),3),
        130*Math.cos(t)-50*Math.cos(2*t)-20*Math.cos(3*t)-10*Math.cos(4*t)+25
      );
    }

    var image=(function(){
      var c=document.createElement('canvas'),ctx2=c.getContext('2d');
      c.width=settings.particles.size;c.height=settings.particles.size;
      function to(t){
        var p=pointOnHeart(t);
        p.x=settings.particles.size/3+p.x*settings.particles.size/550;
        p.y=settings.particles.size/3-p.y*settings.particles.size/550;
        return p;
      }
      ctx2.beginPath();
      var t=-Math.PI,p=to(t);ctx2.moveTo(p.x,p.y);
      while(t<Math.PI){t+=0.01;p=to(t);ctx2.lineTo(p.x,p.y);}
      ctx2.closePath();ctx2.fillStyle='#FF6F91';
      ctx2.fill();
      var img=new Image();img.src=c.toDataURL();return img;
    })();

    function render(){
      requestAnimationFrame(render);
      var newTime=new Date().getTime()/1000,dt=newTime-(time||newTime);time=newTime;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      var amount=particleRate*dt;
      for(var i=0;i<amount;i++){
        var pos=pointOnHeart(Math.PI-2*Math.PI*Math.random());
        var dir=pos.clone().length(settings.particles.velocity);
        particles.add(canvas.width/2+pos.x,canvas.height/2-pos.y,dir.x,-dir.y);
      }
      particles.update(dt);
      particles.draw(ctx,image);
    }
    function onResize(){ canvas.width=canvas.clientWidth; canvas.height=canvas.clientHeight; }
    window.onresize=onResize;
    setTimeout(function(){onResize();render();},10);
  })(document.getElementById('pinkboard'));
})();
</script>
</body>
</html>
